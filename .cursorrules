# Cursor规则: 寸止提示词增强功能使用指南

## 核心原则

### 提示词增强自动化
当我提出需求时,AI必须自动使用寸止的`enhance`工具进行提示词增强,无需我手动指定。

触发条件:
- 我的需求涉及代码实现
- 需求描述较为模糊或简短
- 需要生成完整功能而非简单修改

## MCP工具优先级

### 1. enhance - 提示词增强(新功能)

**何时使用**:
- 实现新功能前先增强需求理解
- 需求描述不够清晰时
- 需要高质量代码生成时
- 涉及复杂业务逻辑时

**调用方式**:
```json
{
  "name": "enhance",
  "arguments": {
    "prompt": "用户的原始需求",
    "enable_pipeline": true,
    "enable_scoring": true,
    "target_score": 90
  }
}
```

**输出包含**:
- 增强后的提示词(消除歧义,补充细节)
- 四层需求分析(字面/意图/场景/补全)
- 任务单(输入/输出/性能/技术栈/验收标准)
- 代码+测试(自动生成并评分)

### 2. zhi - 交互确认(原功能)

**何时使用**:
- 需要用户确认某个操作
- 展示多个方案供选择
- 重要决策需要人工介入
- 功能完成后请求反馈

**调用方式**:
```json
{
  "name": "zhi",
  "arguments": {
    "message": "需要确认的消息(支持Markdown)",
    "predefined_options": ["选项1", "选项2"],
    "is_markdown": true
  }
}
```

### 3. ji - 记忆管理(可选)

**何时使用**:
- 记住项目的重要规范
- 存储最佳实践
- 记录用户偏好

## 标准工作流

### 情况A: 新功能开发

```
用户需求 
  ↓
AI调用 enhance (自动)
  ↓
获取增强结果:
  - 清晰的需求描述
  - 完整的任务单
  - 建议的代码架构
  ↓
AI根据增强结果实施
  ↓
AI调用 zhi 请求确认
  ↓
完成实施
```

### 情况B: 简单修改

```
用户需求
  ↓
AI直接实施(无需enhance)
  ↓
完成并说明
```

### 情况C: 复杂重构

```
用户需求
  ↓
AI调用 enhance (完整模式)
  ↓
展示需求分析和方案
  ↓
AI调用 zhi 确认方案
  ↓
分步实施
  ↓
每个关键步骤后调用 zhi 确认
  ↓
完成
```

## 使用示例

### 示例1: 基础增强

**用户**: 
```
写个用户登录功能
```

**AI内部流程**:
1. 识别这是代码生成需求
2. 自动调用enhance:
```json
{
  "name": "enhance",
  "arguments": {
    "prompt": "写个用户登录功能",
    "enable_pipeline": true,
    "enable_scoring": false,
    "target_score": 85
  }
}
```
3. 根据enhance返回的增强提示词和任务单实施
4. 完成后调用zhi请求确认

**用户看到的**:
```
我理解您需要实现用户登录功能。基于需求分析:

【需求理解】
- 支持邮箱/手机号登录
- JWT令牌认证
- 密码加密存储
- 登录失败限流

【技术方案】
- 使用bcrypt加密密码
- JWT有效期24小时
- Redis存储会话
- 失败5次锁定30分钟

【验收标准】
1. 登录成功返回token
2. 错误处理完整
3. 单元测试覆盖80%+

正在实施...
```

### 示例2: 完整管线

**用户**:
```
/e 实现一个数据统计功能,需要实时展示
```

**AI内部流程**:
1. 识别 `/e` 前缀 → 完整增强模式
2. 调用enhance(完整配置):
```json
{
  "name": "enhance",
  "arguments": {
    "prompt": "/e 实现一个数据统计功能,需要实时展示",
    "enable_pipeline": true,
    "enable_scoring": true,
    "target_score": 90
  }
}
```
3. enhance执行四阶管线:
   - 需求分析(4层)
   - 任务单生成
   - 代码+测试生成
   - 评分闭环(自动重构至90分)
4. 展示完整结果
5. 调用zhi确认后实施

### 示例3: 多模态增强

**用户**:
```
根据这个UI设计图实现前端页面
[附带图片]
```

**AI内部流程**:
1. 识别有图片附件
2. 调用enhance(多模态):
```json
{
  "name": "enhance",
  "arguments": {
    "prompt": "根据这个UI设计图实现前端页面",
    "images": [{
      "data": "base64图片数据",
      "media_type": "image/png",
      "filename": "ui_design.png"
    }],
    "enable_pipeline": true
  }
}
```
3. enhance提取图片信息并整合到需求分析
4. 实施

## 强制规则

### ❌ 禁止行为

1. **禁止跳过enhance** - 除非是简单修改(少于10行)
2. **禁止盲目实施** - 复杂需求必须先enhance再实施
3. **禁止直接询问** - 所有确认必须通过zhi工具
4. **禁止提前声称完成** - 必须完成后通过zhi确认

### ✅ 必须行为

1. **必须自动调用enhance** - 遇到代码生成需求
2. **必须等待工具返回** - 不能异步处理后继续
3. **必须解释增强结果** - 向用户说明需求理解
4. **必须完成后确认** - 通过zhi请求用户验证

## 质量标准

### 提示词增强后应达到

- ✅ 需求无歧义
- ✅ 边界条件明确
- ✅ 技术栈确定
- ✅ 验收标准可量化
- ✅ 错误处理完整

### 代码实施后应达到

- ✅ 符合增强后的任务单
- ✅ 通过所有验收标准
- ✅ 质量评分≥目标分数
- ✅ 有完整的测试用例

## 特殊场景处理

### 场景1: 用户需求过于简单

**用户**: `加个按钮`

**AI处理**:
- 不调用enhance(工具开销大于收益)
- 直接实施
- 完成后说明

### 场景2: 用户需求非常复杂

**用户**: `重构整个认证系统`

**AI处理**:
1. 调用enhance(完整模式)
2. 展示分析结果和任务清单
3. 调用zhi确认大的方向
4. 分步实施,每步完成后确认
5. 全部完成调用zhi最终确认

### 场景3: 用户提供图片

**任何附带图片的需求**

**AI处理**:
1. 自动提取图片的base64编码
2. 调用enhance(传入images参数)
3. enhance会分析图片内容并整合到需求理解
4. 基于增强结果实施

## 错误处理

### enhance调用失败

如果enhance工具返回错误:
1. 记录错误信息
2. 降级到基础模式(不使用enhance)
3. 告知用户降级情况
4. 正常完成任务

### zhi调用失败

如果zhi工具返回错误:
1. 记录错误
2. 在响应中直接询问用户(降级)
3. 等待用户确认
4. 继续任务

## 配置要求

### 前置条件

1. MCP服务器已配置
2. 寸止工具可执行(release版本)
3. MCP客户端(Cursor)已连接

### 验证方法

用户可以运行:
```
列出所有MCP工具
```

应该看到:
- `zhi` - 智能交互工具
- `enhance` - 提示词增强工具
- `ji` - 记忆管理工具(可选)

## 最佳实践

### 何时使用完整管线

- 新项目启动时
- 核心功能开发
- 复杂业务逻辑
- 性能敏感场景
- 需要高质量代码

### 何时使用基础增强

- 快速原型验证
- 简单功能实现
- 时间紧迫情况
- 已有清晰需求

### 何时跳过enhance

- 修改少于10行
- 纯配置更改
- 文档编写
- 简单重命名

## 性能优化

### enhance工具调用开销

- 基础模式: ~2秒
- 完整管线: ~10-30秒(取决于复杂度)
- 评分闭环: 额外 ~5-15秒/轮

### 权衡建议

- 简单任务不值得完整管线
- 复杂任务值得投入时间增强
- 根据项目重要性调整target_score

## 总结

遵循以上规则,AI将:
1. 自动识别何时使用enhance
2. 正确配置enhance参数
3. 等待并解释enhance结果
4. 根据增强结果高质量实施
5. 通过zhi与用户交互
6. 确保最终质量达标

这将显著提升代码质量和需求理解准确度,实现从32%到90%的一次通过率提升!

---

**注意**: 本规则文件应放置在项目根目录或`.cursorrules`文件中,Cursor会自动加载并遵循这些规则。

